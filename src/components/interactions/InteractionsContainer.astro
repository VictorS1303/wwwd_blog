---
import { supabaseClient } from "../../../js/supabase/supabase_client"
import Button from "../../components/button/Button.astro"
import Header from "../../components/header/Header.astro"
import Dialog from "../dialog/Dialog.astro"

const { interactionButtons = [], post } = Astro.props

const dialogButtons = [
  {
    buttonText: "Sign up",
    href: "/sign-up",
  },
  {
    buttonText: "Login",
    href: "/login",
  },
]
---

<div class="interaction-buttons-container mt-12">
  <Header headerText="Like & Share" isTextBlockHeader={true} />
  <div class="flex gap-4 mt-4">
    {
      interactionButtons.length > 0 &&
        interactionButtons.map((interactionButton) => (
          <Button
            data-post-id={post.id}
            id={interactionButton.id}
            class={interactionButton.class}
            href={interactionButton.href}
            download={interactionButton.download}
            share={interactionButton.share}
            isInteractionButton={[
              "like_button",
              "save_button",
              "share_button",
            ].includes(interactionButton.id)}
          />
        ))
    }
  </div>
</div>

<!-- Login Warning Modal -->
<Dialog
  id="login_warning_modal"
  type="login"
  headerText="YOU ARE NOT LOGGED IN"
  textBlockParagraphText="You must be logged in to continue."
  dialogButtons={dialogButtons}
/>

<!-- Share Modal -->
<Dialog
  id="share_blog_post_modal"
  type="share"
  headerText="URL COPIED TO CLIPBOARD"
  textBlockParagraphText="The blog post is now ready to be shared wherever and with whomever you want!"
/>

<!-- Post Already Saved Modal -->
<Dialog
  id="post_already_saved_modal"
  type="share"
  headerText="POST ALREADY SAVED"
  textBlockParagraphText="You have already saved this post!"
/>

<!-- Post Saved Modal -->
<Dialog
  id="post_saved_modal"
  type="share"
  headerText="POST SAVED"
  textBlockParagraphText="You have successfully saved this post!"
/>

<!-- Post Liked Modal -->
<Dialog
  id="post_liked_modal"
  type="share"
  headerText="POST LIKED"
  textBlockParagraphText="You have successfully liked this post!"
/>

<!-- Post Already Liked Modal -->
<Dialog
  id="post_already_liked_modal"
  type="share"
  headerText="POST ALREADY LIKED"
  textBlockParagraphText="You have already liked this post!"
/>

<script>
  import { supabaseClient } from "../../../js/supabase/supabase_client"
  import { isPostLiked } from "../../../js/utils/supabase_methods.js"
  import {
    likePost,
    savePost,
    isPostSaved,
  } from "../../../js/utils/supabase_methods.js"

  const interactionButtonsContainer = document.querySelector(
    ".interaction-buttons-container",
  )

  const loginWarningModal = document.querySelector("#login_warning_modal")
  const shareBlogPostModal = document.querySelector("#share_blog_post_modal")
  const postSavedModal = document.querySelector("#post_saved_modal")
  const alreadySavedModal = document.querySelector("#post_already_saved_modal")
  const postLikedModal = document.querySelector("#post_liked_modal")
  const postAlreadyLikedModal = document.querySelector(
    "#post_already_liked_modal",
  )

  const likeButton = document.querySelector<HTMLButtonElement>("#like_button")

  interactionButtonsContainer?.addEventListener("click", (e) =>
    chooseInteraction(e),
  )

  function chooseInteraction(e) {
    const button = e.target.closest("button, a")
    if (!button) return

    const postId = button.dataset.postId

    switch (button.id) {
      case "like_button":
        handlePostLike(postId)
        break
      case "save_button":
        handleSavePost(postId)
        break
      case "download_button":
        downloadPost()
        break
      case "share_button":
        sharePost()
        break
      default:
        console.log("No action defined for this button")
    }
  }

  async function handlePostLike(postId) {
    const {
      data: { user },
    } = await supabaseClient.auth.getUser()

    if (!user) {
      loginWarningModal?.showModal()
      return
    }

    const isAlreadyLiked = await isPostLiked(postId)

    if (isAlreadyLiked) {
      console.log("Post is already liked!")
      postAlreadyLikedModal?.showModal()
      return
    } else {
      await likePost(postId)
      console.log("Post liked!")
      postLikedModal?.showModal()
    }
  }

  async function handleSavePost(postId) {
    const {
      data: { user },
    } = await supabaseClient.auth.getUser()

    if (!user) {
      loginWarningModal?.showModal()
      return
    }

    const isAlreadySaved = await isPostSaved(postId)

    if (isAlreadySaved) {
      console.log("Post is already saved!")
      alreadySavedModal?.showModal()
      return
    }

    await savePost(postId)
    console.log("Post saved!")
    postSavedModal?.showModal()
  }

  function downloadPost() {
    console.log("Post downloaded!")
  }

  function sharePost() {
    const postUrl = window.location.href
    navigator.clipboard.writeText(postUrl).then(() => {
      shareBlogPostModal?.showModal()
    })
  }
</script>
