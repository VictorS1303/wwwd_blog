---
import { fetchAllPosts, fetchHeroData } from "../../js/utils/supabase_methods"
import Layout from "../layouts/Layout.astro"
import Hero from "../components/hero/Hero.astro"
import BlogPostsSection from "../components/posts/BlogPostsSection.astro"
import ScrollToTopButton from "../components/button/ScrollToTopButton.astro"

const posts = await fetchAllPosts()
const categoryParam = Astro.url.searchParams.get("category")?.toLowerCase()

// Filter posts by category
const filteredPosts = categoryParam
  ? posts.filter((post) => {
      return post.post_categories.some(
        (category) => category.toLowerCase() === categoryParam,
      )
    })
  : posts

const heroData = await fetchHeroData()
const heroImage = heroData[0]?.hero_images // e.g., "blog_posts_hero"
const heroText = heroData[0]?.hero_text
const heroAlt = heroData[0]?.hero_alt
---

<Layout title="Blog Posts">
  <Hero src={heroImage} alt={heroAlt} headerText={heroText} hasOverlay={true} />

  <BlogPostsSection
    posts={filteredPosts}
    headerText="Posts"
    isTextBlockHeader={true}
  />

  <ScrollToTopButton />
</Layout>
