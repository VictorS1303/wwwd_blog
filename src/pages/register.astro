---
import LoginSignUpLayout from "../layouts/LoginSignUpLayout.astro"
import Form from "../components/form/Form.astro"
import Button from "../components/button/Button.astro"
import Dialog from "../components/dialog/Dialog.astro"

const signUpFormInputs = [
  {
    type: "text",
    label: "Name",
    name: "name",
    placeholder: "Enter your name",
    required: true,
  },
  {
    type: "email",
    label: "Email",
    name: "email",
    placeholder: "Enter your email",
    required: true,
  },
  {
    type: "password",
    label: "Password",
    name: "password",
    required: true,
    placeholder: "Please enter password",
  },
  {
    type: "password",
    label: "Repeat password",
    name: "repeat_password",
    required: true,
    placeholder: "Please repeat password",
  },
]
---

<LoginSignUpLayout title="Register">
  <Form
    isFormHeader={true}
    headerText="Register"
    inputs={signUpFormInputs}
    isSubmitButton={true}
    id="sign_up_form"
    buttonText="Register"
  />
  <div class="text-center mt-4">
    <h4>
      Already a user? Log in <Button href="/login" buttonText="here." />
    </h4>
  </div>

  <!-- Register Failed Modal -->
  <Dialog
    id="register_failed_modal"
    type="warning"
    headerText="REGISTER FAILED"
    textBlockParagraphText="At least one of the credentials was wrong. Please try again!"
  />

  <!-- Register Succeeded Modal -->
  <Dialog
    id="register_succeeded_modal"
    type="warning"
    headerText="REGISTERING SUCCEEDED"
    textBlockParagraphText="Registering happened successfully! You will be logged in and redirected shortly!"
  />
</LoginSignUpLayout>

<script>
  import { supabaseClient } from "../../js/supabase/supabase_client"
  import { registerAndLogin } from "../../js/utils/supabase_methods"

  const signUpForm = document.querySelector("#sign_up_form")
  const registerFailedModal = document.querySelector("#register_failed_modal")
  const registerSucceededModal = document.querySelector(
    "#register_succeeded_modal",
  )

  signUpForm?.addEventListener("submit", (e) => handleSignUp(e))

  async function handleSignUp(e) {
    e.preventDefault()

    const formData = new FormData(signUpForm)
    const nameInput = formData.get("name")
    const emailInput = formData.get("email")
    const passwordInput = formData.get("password")
    const repeatPasswordInput = formData.get("repeat_password")

    if (repeatPasswordInput !== passwordInput) {
      alert("Passwords do not match!")
      return
    }

    const signUpResult = await registerAndLogin(
      nameInput,
      emailInput,
      passwordInput,
    )
    if (!signUpResult.success) {
      registerFailedModal?.showModal()
      // alert(`Sign-up failed: ${signUpResult.error}`)
      return
    }

    // Sign-up succeeded, redirect
    signUpForm?.reset()

    registerSucceededModal?.showModal()
    setTimeout(() => {
      window.location.href = "/blog-posts"
    }, 2000)
  }
</script>
