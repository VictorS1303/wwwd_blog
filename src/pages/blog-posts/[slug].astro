---
import { fetchSinglePostBySlug } from "../../../js/utils/supabase_methods"
import BlogPostLayout from "../../layouts/BlogPostLayout.astro"
import { supabaseClient } from "../../../js/supabase/supabase_client"
import { marked } from "marked"

// Fetch single post
const { slug } = Astro.params
const post = await fetchSinglePostBySlug(slug)

const fileKey = `${post.post_download_url}.pdf`

const { data: postDownloadData } = supabaseClient.storage
  .from("downloadable-posts")
  .getPublicUrl(fileKey, { download: true })

post.post_download_url = postDownloadData.publicUrl

let html = ""
if (post?.post_text) {
  html = marked(post.post_text)
} else {
  console.warn("No post text found for slug:", slug)
}
---

<BlogPostLayout
  title={post.post_title}
  date={post.publish_date}
  authorName={post.author}
  priorKnowledge={post.prior_knowledge}
  download={post.post_download_url}
  readingTime={post.reading_time}
  image={{ src: post.post_image, alt: post.post_image_alt }}
>
  <div set:html={html} />
</BlogPostLayout>
