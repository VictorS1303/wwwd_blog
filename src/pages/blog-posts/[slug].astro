---
import { fetchSinglePostBySlug } from "../../../js/utils/supabase_methods"
import BlogPostLayout from "../../layouts/BlogPostLayout.astro"
import { supabaseClient } from "../../../js/supabase/supabase_client"
import { marked } from "marked"
import ScrollToTopButton from "../../components/button/ScrollToTopButton.astro"
import Footer from "../../components/footer/Footer.astro"

const { slug } = Astro.params

// Fetch full post (includes categories already)
const post = await fetchSinglePostBySlug(slug)

if (!post) {
  throw new Error(`No post found for slug "${slug}"`)
}

// File download handling
const fileKey = `${post.post_download_url}.pdf`

const { data: postDownloadData } = supabaseClient.storage
  .from("downloadable-posts")
  .getPublicUrl(fileKey, { download: true })

post.post_download_url = postDownloadData.publicUrl

// Convert markdown to HTML
let html = ""
if (post?.post_text) {
  html = marked(post.post_text)
} else {
  console.warn("No post text found for slug:", slug)
}
---

<BlogPostLayout
  title={post.post_title}
  date={post.publish_date}
  authorName={post.author}
  categories={post.post_categories}
  priorKnowledge={post.prior_knowledge}
  download={post.post_download_url}
  readingTime={post.reading_time}
  image={{ src: post.post_image, alt: post.post_image_alt }}
>
  <div set:html={html} />

  <ScrollToTopButton />
</BlogPostLayout>
